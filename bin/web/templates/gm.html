<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Turn V2 - Web Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }
        .rolling {
            animation: roll 0.5s ease-in-out;
        }
        .dice-pip {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
        }
        #bg-art {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 min-h-screen text-white relative overflow-x-hidden">
    <!-- Background Art Overlay - Rotating Wayne Reynolds Art -->
    <div id="bg-art" class="fixed inset-0 opacity-30 pointer-events-none bg-cover bg-center bg-no-repeat" style="filter: blur(2px); background-image: url('https://www.waynereynolds.com/images/fantasy-art-gallery-1/pathfinder-goblins-wayne-reynolds.jpg');"></div>
    
    <div class="container mx-auto px-4 py-8 max-w-6xl relative z-10">
        
        <!-- Back Button -->
        <div class="mb-4">
            <a href="/" class="inline-flex items-center gap-2 bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg transition text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back to Main Menu
            </a>
        </div>
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold mb-2 bg-gradient-to-r from-purple-400 to-pink-600 bg-clip-text text-transparent drop-shadow-lg">
                Dungeon Turn V2
            </h1>
            <p class="text-gray-400">Roll the dice jar and discover what happens!</p>
            <p class="text-xs text-gray-600 mt-2">Art by Wayne Reynolds</p>
        </div>

        <!-- Dice Jar Tracker -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-2xl border border-purple-500">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold">Dice Jar</h2>
                <div class="flex gap-2">
                    <button onclick="addDie()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition">
                        + Add Die
                    </button>
                    <button onclick="resetJar()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition">
                        Reset
                    </button>
                </div>
            </div>
            <div class="flex gap-4 justify-center" id="dice-jar-display">
                <!-- Dice will be added here -->
            </div>
            <p class="text-center mt-4 text-gray-400" id="jar-status">
                Add dice as players explore (10 min = 1 die)
            </p>
        </div>

        <!-- Main Controls -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            
            <!-- Floor Selector -->
            <div class="bg-gray-800 rounded-lg p-6 shadow-2xl border border-purple-500">
                <h2 class="text-2xl font-bold mb-4">Current Floor</h2>
                <div class="grid grid-cols-5 gap-2">
                    <button onclick="selectFloor(1)" class="floor-btn bg-purple-600 hover:bg-purple-700 px-4 py-3 rounded-lg transition font-bold">1</button>
                    <button onclick="selectFloor(2)" class="floor-btn bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition font-bold">2</button>
                    <button onclick="selectFloor(3)" class="floor-btn bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition font-bold">3</button>
                    <button onclick="selectFloor(4)" class="floor-btn bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition font-bold">4</button>
                    <button onclick="selectFloor(5)" class="floor-btn bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition font-bold">5</button>
                    <button onclick="selectFloor(6)" class="floor-btn bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition font-bold">6</button>
                    <button onclick="selectFloor(7)" class="floor-btn bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition font-bold">7</button>
                    <button onclick="selectFloor(8)" class="floor-btn bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition font-bold">8</button>
                    <button onclick="selectFloor(9)" class="floor-btn bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition font-bold">9</button>
                    <button onclick="selectFloor(10)" class="floor-btn bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg transition font-bold">10</button>
                </div>
                <p class="text-center mt-4 text-gray-400" id="floor-name">The Lighthouse (Surface Level)</p>
                
                <!-- Test Button for Rapid Floor Testing -->
                <button onclick="testFloorFiltering()" class="w-full mt-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    üß™ Test Floor Filter (Generate 5 Events)
                </button>
            </div>

            <!-- Manual Dice Input -->
            <div class="bg-gray-800 rounded-lg p-6 shadow-2xl border border-purple-500">
                <h2 class="text-2xl font-bold mb-4">Dice Roll</h2>
                <p class="text-gray-400 text-sm mb-4">Roll 5d20 physically OR use auto-roll:</p>
                
                <!-- Auto Roll Button -->
                <button onclick="autoRoll5d20()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg mb-3 transition transform hover:scale-105 shadow-lg">
                    üé≤ AUTO-ROLL 5d20
                </button>
                
                <!-- Manual Input -->
                <p class="text-gray-400 text-xs mb-2 text-center">Or enter total manually:</p>
                <input type="number" id="dice-input" min="5" max="100" 
                    class="w-full bg-gray-700 text-white text-3xl font-bold py-4 px-4 rounded-lg mb-4 text-center border-2 border-purple-500 focus:border-pink-500 focus:outline-none"
                    placeholder="5-100"
                    title="Enter the sum of 5d20 (between 5 and 100). Extreme rolls (5-8, 97-100) trigger wild events!">
                <button onclick="getDiceEncounter()" id="get-encounter-btn" 
                    class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-4 rounded-lg text-xl transition transform hover:scale-105 shadow-lg">
                    üé≤ GET ENCOUNTER
                </button>
                <p class="text-center mt-2 text-xs text-gray-500">Extreme rolls (5-8, 97-100) are WILD!</p>
            </div>
        </div>

        <!-- Event Filters -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-2xl border border-purple-500 mb-6">
            <button onclick="toggleFilters()" class="w-full flex justify-between items-center mb-4 hover:bg-gray-700 p-2 rounded transition">
                <h2 class="text-2xl font-bold">Event Filters</h2>
                <svg id="filters-arrow" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="filters-content" class="hidden">
            
            <!-- Filter Controls -->
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <!-- Event Category Multi-Select -->
                <div>
                    <label class="block text-sm font-bold mb-2">Event Categories</label>
                    <select id="filter-categories" multiple class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-purple-500 focus:border-pink-500 focus:outline-none" style="min-height: 100px;">
                        <option value="OPPORTUNITY">Opportunity</option>
                        <option value="COMPLICATION">Complication</option>
                        <option value="DILEMMA">Dilemma</option>
                        <option value="ACTIVE_THREAT">Active Threat</option>
                    </select>
                </div>
                
                <!-- Skills Multi-Select -->
                <div>
                    <label class="block text-sm font-bold mb-2">Skills</label>
                    <select id="filter-skills" multiple class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-purple-500 focus:border-pink-500 focus:outline-none" style="min-height: 100px;">
                        <option value="Perception">Perception</option>
                        <option value="Stealth">Stealth</option>
                        <option value="Thievery">Thievery</option>
                        <option value="Athletics">Athletics</option>
                        <option value="Acrobatics">Acrobatics</option>
                        <option value="Arcana">Arcana</option>
                        <option value="Nature">Nature</option>
                        <option value="Medicine">Medicine</option>
                        <option value="Diplomacy">Diplomacy</option>
                        <option value="Intimidation">Intimidation</option>
                        <option value="Deception">Deception</option>
                        <option value="Society">Society</option>
                        <option value="Religion">Religion</option>
                        <option value="Crafting">Crafting</option>
                        <option value="Survival">Survival</option>
                    </select>
                </div>
                
                <!-- Time Cost Multi-Select -->
                <div>
                    <label class="block text-sm font-bold mb-2">Time Cost</label>
                    <select id="filter-time-cost" multiple class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-purple-500 focus:border-pink-500 focus:outline-none">
                        <option value="quick">Quick (1-3 actions)</option>
                        <option value="short">Short (5-10 min)</option>
                        <option value="long">Long (20-30 min)</option>
                    </select>
                </div>
                
                <!-- New Area Single-Select -->
                <div>
                    <label class="block text-sm font-bold mb-2">New/Unfamiliar Area</label>
                    <select id="filter-new-area" class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-purple-500 focus:border-pink-500 focus:outline-none">
                        <option value="either">Either</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                
                <!-- Reward Type Text Search (for OPPORTUNITY events) -->
                <div>
                    <label class="block text-sm font-bold mb-2">Reward Type (Opportunities)</label>
                    <input type="text" id="filter-reward" placeholder="e.g., healing, gold, tactical" 
                        class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-purple-500 focus:border-pink-500 focus:outline-none">
                </div>
                
                <!-- Threat Level Multi-Select (for ACTIVE_THREAT events) -->
                <div>
                    <label class="block text-sm font-bold mb-2">Threat Level (Active Threats)</label>
                    <select id="filter-threat-level" multiple class="w-full bg-gray-700 text-white px-3 py-2 rounded border border-purple-500 focus:border-pink-500 focus:outline-none">
                        <option value="Low">Low</option>
                        <option value="Moderate">Moderate</option>
                        <option value="High">High</option>
                        <option value="Extreme">Extreme</option>
                    </select>
                </div>
            </div>
            
            <!-- Matching Count and Actions -->
            <div class="flex justify-between items-center mb-4">
                <div>
                    <span class="text-lg font-bold">Matching Events: </span>
                    <span id="matching-count" class="text-2xl text-green-400">0</span>
                </div>
                <button onclick="clearAllFilters()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition font-bold">
                    Clear All Filters
                </button>
            </div>
            
            <!-- Event Preview List -->
            <div class="bg-gray-700 rounded-lg p-4 mb-4 max-h-48 overflow-y-auto">
                <h3 class="text-sm font-bold mb-2">Available Events:</h3>
                <ul id="event-preview-list" class="text-sm text-gray-300 space-y-1">
                    <!-- Preview items populated by JavaScript -->
                </ul>
            </div>
            
            <!-- Generate Event Button -->
            <button onclick="generateFilteredEvent()" id="generate-filtered-event-btn" 
                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-4 rounded-lg text-xl transition transform hover:scale-105 shadow-lg">
                üé≤ GENERATE FILTERED EVENT
            </button>
            </div>
        </div>

        <!-- Encounter Display -->
        <div id="encounter-display" class="hidden bg-gray-800 rounded-lg p-6 shadow-2xl border border-purple-500 mb-6">
            <!-- Encounter content will be inserted here -->
        </div>

        <!-- Other Generators -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-2xl border border-purple-500 mb-6">
            <button onclick="toggleGenerators()" class="w-full flex justify-between items-center mb-4 hover:bg-gray-700 p-2 rounded transition">
                <h2 class="text-2xl font-bold">Other Generators</h2>
                <svg id="generators-arrow" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="generators-content" class="hidden">
            <div class="grid md:grid-cols-3 gap-4">
                
                <!-- NPC Generator -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üßô Generate NPC</h3>
                    <p class="text-sm text-gray-400 mb-3">Create a random NPC with backstory</p>
                    <button onclick="generateNPC()" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition font-bold">
                        Generate NPC
                    </button>
                </div>

                <!-- Merchant Generator -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üè™ Generate Merchant</h3>
                    <p class="text-sm text-gray-400 mb-3">Create a merchant with inventory</p>
                    <input type="text" id="merchant-name" placeholder="Merchant Name" 
                        class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Enter a name for the merchant (leave blank for random)">
                    <input type="number" id="merchant-level" placeholder="Level (1-20)" min="1" max="20" value="4" 
                        class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Party level determines max item level (party level + 2)">
                    <button onclick="generateMerchant()" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition font-bold">
                        Generate Merchant
                    </button>
                </div>

                <!-- 4d20 Encounters -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üé≤ 4d20 Encounter</h3>
                    <p class="text-sm text-gray-400 mb-3">Fogfen/Otari wilderness encounters</p>
                    <input type="number" id="encounter-4d20" placeholder="4d20 Total (4-80)" min="4" max="80" 
                        class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Enter the sum of 4d20 (between 4 and 80) for wilderness encounters">
                    <button onclick="generate4d20Encounter()" class="w-full bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg transition font-bold">
                        Generate Encounter
                    </button>
                </div>

                <!-- Dungeon Turn V1 -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üé≤ Dungeon Turn V1</h3>
                    <p class="text-sm text-gray-400 mb-3">Original dungeon turn system</p>
                    <select id="v1-floor" class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Select which floor of Gauntlight to generate an encounter for">
                        <option value="1">Floor 1</option>
                        <option value="2">Floor 2</option>
                        <option value="3">Floor 3</option>
                        <option value="4">Floor 4</option>
                        <option value="5">Floor 5</option>
                    </select>
                    <button onclick="generateV1Encounter()" class="w-full bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg transition font-bold">
                        Generate V1 Encounter
                    </button>
                </div>

                <!-- View Docs -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üìö Documentation</h3>
                    <p class="text-sm text-gray-400 mb-3">View guides and references</p>
                    <select id="doc-select" class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Select a document to view">
                        <option value="">Select a document...</option>
                        <option value="docs/EXTREME_ENCOUNTERS.md">Extreme Encounters Guide</option>
                        <option value="docs/DUNGEON_TURN_REDESIGN.md">Dungeon Turn Design</option>
                        <option value="players/DUNGEON_EXPLORATION_GUIDE.md">Player Exploration Guide</option>
                        <option value="gm/DUNGEON_TURN_V2_QUICK_REFERENCE.md">GM Quick Reference</option>
                    </select>
                    <button onclick="viewDoc()" class="w-full bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition font-bold">
                        View Document
                    </button>
                </div>

                <!-- Hazard Generator -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">‚ö†Ô∏è Generate Hazard</h3>
                    <p class="text-sm text-gray-400 mb-3">Random trap or environmental hazard</p>
                    <input type="number" id="hazard-level" placeholder="Hazard Level (-1 to 10)" min="-1" max="10" value="1" 
                        class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Hazard level (-1 for trivial, 0-10 for standard hazards)">
                    <button onclick="generateHazard()" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition font-bold">
                        Generate Hazard
                    </button>
                </div>

                <!-- ALL Merchants Generator -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üè™ Generate ALL Merchants</h3>
                    <p class="text-sm text-gray-400 mb-3">Regenerate all Otari merchants with inventory</p>
                    <input type="number" id="all-merchants-level" placeholder="Party Level (1-20)" min="1" max="20" value="4" 
                        class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Party level determines max item level for all merchants (party level + 2)">
                    <button onclick="generateAllMerchants()" id="generate-all-merchants-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition font-bold">
                        Generate All Merchants
                    </button>
                    <div id="merchant-progress" class="hidden mt-3">
                        <div class="w-full bg-gray-600 rounded-full h-4 mb-2">
                            <div id="merchant-progress-bar" class="bg-indigo-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="merchant-status" class="text-xs text-gray-400 text-center">Starting...</p>
                    </div>
                </div>

                <!-- Data Integrity Checker -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üîç Check Data Integrity</h3>
                    <p class="text-sm text-gray-400 mb-3">Verify equipment/creatures against AoN</p>
                    <select id="integrity-type" class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Select which type of data to verify against Archives of Nethys">
                        <option value="equipment">Equipment</option>
                        <option value="creatures">Creatures</option>
                        <option value="deities">Deities</option>
                    </select>
                    <input type="number" id="integrity-count" placeholder="Items to check (or 'all')" min="1" value="10" 
                        class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Number of random items to check (use 'all' to check everything - takes a long time!)">
                    <label class="flex items-center text-sm mb-2" title="Automatically update mismatched items with correct data from AoN">
                        <input type="checkbox" id="integrity-fix" class="mr-2">
                        Auto-fix mismatches
                    </label>
                    <button onclick="runDataIntegrity()" id="integrity-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 px-4 py-2 rounded-lg transition font-bold">
                        Check Data
                    </button>
                    <p id="integrity-status" class="text-xs text-gray-400 mt-2 hidden"></p>
                </div>

                <!-- Scrape Creatures -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üï∑Ô∏è Scrape Creatures</h3>
                    <p class="text-sm text-gray-400 mb-3">Update creature database from AoN</p>
                    <button onclick="scrapeCreatures()" id="scrape-creatures-btn" class="w-full bg-teal-600 hover:bg-teal-700 px-4 py-2 rounded-lg transition font-bold"
                        title="Scrapes ALL creatures from Archives of Nethys - takes several minutes">
                        Scrape All Creatures
                    </button>
                    <p id="scrape-creatures-status" class="text-xs text-gray-400 mt-2 hidden"></p>
                </div>

                <!-- Scrape Creature Lore -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üìñ Scrape Creature Lore</h3>
                    <p class="text-sm text-gray-400 mb-3">Update creature lore from AoN</p>
                    <button onclick="scrapeCreatureLore()" id="scrape-lore-btn" class="w-full bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded-lg transition font-bold"
                        title="Scrapes creature lore and descriptions from Archives of Nethys">
                        Scrape Lore
                    </button>
                    <p id="scrape-lore-status" class="text-xs text-gray-400 mt-2 hidden"></p>
                </div>

                <!-- Scrape Spells -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">‚ú® Scrape Spells</h3>
                    <p class="text-sm text-gray-400 mb-3">Update spell database from AoN</p>
                    <button onclick="scrapeSpells()" id="scrape-spells-btn" class="w-full bg-violet-600 hover:bg-violet-700 px-4 py-2 rounded-lg transition font-bold"
                        title="Scrapes ALL spells from Archives of Nethys - takes several minutes">
                        Scrape Spells
                    </button>
                    <p id="scrape-spells-status" class="text-xs text-gray-400 mt-2 hidden"></p>
                </div>

                <!-- Expand Encounter Pools -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üé≤ Expand Encounter Pools</h3>
                    <p class="text-sm text-gray-400 mb-3">Generate expanded encounter pools</p>
                    <button onclick="expandEncounterPools()" id="expand-pools-btn" class="w-full bg-lime-600 hover:bg-lime-700 px-4 py-2 rounded-lg transition font-bold"
                        title="Expands encounter pools with additional creatures and variations">
                        Expand Pools
                    </button>
                    <p id="expand-pools-status" class="text-xs text-gray-400 mt-2 hidden"></p>
                </div>

                <!-- Reset Verification Dates -->
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2">üîÑ Reset Verification</h3>
                    <p class="text-sm text-gray-400 mb-3">Reset AoN verification dates</p>
                    <select id="reset-type" class="w-full bg-gray-600 text-white px-3 py-2 rounded mb-2 text-sm"
                        title="Select which data type to reset verification dates for (forces re-checking)">
                        <option value="equipment">Equipment</option>
                        <option value="creatures">Creatures</option>
                        <option value="deities">Deities</option>
                    </select>
                    <button onclick="resetVerification()" id="reset-verify-btn" class="w-full bg-rose-600 hover:bg-rose-700 px-4 py-2 rounded-lg transition font-bold">
                        Reset Dates
                    </button>
                    <p id="reset-verify-status" class="text-xs text-gray-400 mt-2 hidden"></p>
                </div>

            </div>
            </div>
        </div>

        <!-- Generator Output -->
        <div id="generator-output" class="hidden bg-gray-800 rounded-lg p-6 shadow-2xl border border-purple-500 mb-6">
            <!-- Generator content will be inserted here -->
        </div>

        <!-- History -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-2xl border border-purple-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Roll History</h2>
                <button onclick="clearHistory()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition text-sm">
                    Clear
                </button>
            </div>
            <div id="history-display" class="space-y-2">
                <p class="text-gray-400 text-center">No rolls yet</p>
            </div>
        </div>
    </div>



    <script>
        let currentFloor = 1;
        let currentDiceJar = 0;
        let partyLevel = 4;

        const floorNames = {
            1: "The Lighthouse (Surface Level)",
            2: "Servants' Quarters (Underground)",
            3: "The Library",
            4: "Belcorra's Retreat",
            5: "The Arena",
            6: "Fleshwarping Laboratories",
            7: "The Prison (Mini-Hell)",
            8: "The Farm (Bog Mummy Level)",
            9: "The Hunting Grounds (Darklands Caverns)",
            10: "The Empty Vault (Temple to Nhimbaloth)"
        };

        // Wayne Reynolds Pathfinder Art URLs
        const backgroundArt = [
            'https://images.squarespace-cdn.com/content/v1/5bd88db093a6320f071b1a50/1593019848989-YJXQVH–∫–æ–π–µ8YJXQVHKOJE8/pathfinder-iconic-characters.jpg',
            'https://www.waynereynolds.com/images/fantasy-art-gallery-2/pathfinder-iconic-characters-wayne-reynolds.jpg',
            'https://www.waynereynolds.com/images/fantasy-art-gallery-1/pathfinder-goblins-wayne-reynolds.jpg',
            'https://www.waynereynolds.com/images/fantasy-art-gallery-2/pathfinder-cover-art-wayne-reynolds.jpg'
        ];

        // Set random background art on load
        function setBackgroundArt() {
            const bgElement = document.getElementById('bg-art');
            const randomArt = backgroundArt[Math.floor(Math.random() * backgroundArt.length)];
            bgElement.style.backgroundImage = `url('${randomArt}')`;
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async function() {
            setBackgroundArt();
            updateDiceJar(0);
            updateHistory();
            
            // Load event data for filtering
            await loadEventData();
            
            // Enter key support
            document.getElementById('dice-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    getDiceEncounter();
                }
            });
        });

        // Load event data and initialize filter manager
        async function loadEventData() {
            try {
                const response = await fetch('/api/events');
                const eventsData = await response.json();
                
                // Flatten events from all categories
                const flatEvents = [];
                for (const [category, events] of Object.entries(eventsData)) {
                    for (const event of events) {
                        event.category = category;
                        flatEvents.push(event);
                    }
                }
                
                // Initialize EventFilterManager with event data
                EventFilterManager.init(flatEvents);
            } catch (error) {
                console.error('Error loading event data:', error);
                // Show error in preview list
                document.getElementById('event-preview-list').innerHTML = 
                    '<li class="text-red-400">Error loading events. Please refresh the page.</li>';
            }
        }

        function selectFloor(floor) {
            currentFloor = floor;
            document.querySelectorAll('.floor-btn').forEach(btn => {
                btn.classList.remove('bg-purple-600');
                btn.classList.add('bg-gray-700');
            });
            event.target.classList.remove('bg-gray-700');
            event.target.classList.add('bg-purple-600');
            document.getElementById('floor-name').textContent = floorNames[floor];
        }

        // Auto-roll 5d20 with proper bell curve statistics
        function autoRoll5d20() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'üé≤ Rolling...';
            
            // Roll 5d20
            const rolls = [];
            for (let i = 0; i < 5; i++) {
                rolls.push(Math.floor(Math.random() * 20) + 1);
            }
            
            // Calculate sum
            const sum = rolls.reduce((a, b) => a + b, 0);
            
            // Animate the rolls
            const input = document.getElementById('dice-input');
            let displayIndex = 0;
            const animationInterval = setInterval(() => {
                if (displayIndex < rolls.length) {
                    input.value = rolls.slice(0, displayIndex + 1).join(' + ') + ' = ' + rolls.slice(0, displayIndex + 1).reduce((a, b) => a + b, 0);
                    displayIndex++;
                } else {
                    clearInterval(animationInterval);
                    input.value = sum;
                    
                    // Show the individual rolls briefly
                    setTimeout(() => {
                        // Auto-trigger encounter generation
                        getDiceEncounter();
                        btn.disabled = false;
                        btn.textContent = 'üé≤ AUTO-ROLL 5d20';
                    }, 500);
                }
            }, 300);
        }

        async function getDiceEncounter() {
            const input = document.getElementById('dice-input');
            const total = parseInt(input.value);
            
            if (!total || total < 5 || total > 100) {
                alert('Please enter a number between 5 and 100');
                return;
            }

            const btn = document.getElementById('get-encounter-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';

            // Use default context parameters for dice-based generation
            // (backward compatibility - no filters)
            const encounterResponse = await fetch('/api/encounter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    floor: currentFloor,
                    sum: total,
                    party_level: partyLevel,
                    space_type: 'unknown',
                    party_status: 'healthy',
                    recent_combat: false,
                    new_area: true
                })
            });
            const encounter = await encounterResponse.json();

            displayEncounter(encounter, total);
            updateHistory();
            resetJar();
            
            // Clear input
            input.value = '';

            btn.disabled = false;
            btn.textContent = 'üé≤ GET ENCOUNTER';
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('dice-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    getDiceEncounter();
                }
            });
        });

        async function generateNPC() {
            const output = document.getElementById('generator-output');
            output.innerHTML = '<p class="text-center">Generating NPC...</p>';
            output.classList.remove('hidden');
            
            const response = await fetch('/api/generate-npc');
            const data = await response.json();
            
            output.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">üßô ${data.name}</h3>
                <div class="prose prose-invert max-w-none">
                    <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded">${data.content}</pre>
                </div>
            `;
            output.scrollIntoView({ behavior: 'smooth' });
        }

        async function generateMerchant() {
            const name = document.getElementById('merchant-name').value || 'Random Merchant';
            const level = parseInt(document.getElementById('merchant-level').value) || 4;
            
            const output = document.getElementById('generator-output');
            output.innerHTML = '<p class="text-center">Generating merchant...</p>';
            output.classList.remove('hidden');
            
            const response = await fetch('/api/generate-merchant', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, level })
            });
            const data = await response.json();
            
            output.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">üè™ ${data.name}</h3>
                <div class="prose prose-invert max-w-none">
                    <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded">${data.content}</pre>
                </div>
            `;
            output.scrollIntoView({ behavior: 'smooth' });
        }

        async function generate4d20Encounter() {
            const total = parseInt(document.getElementById('encounter-4d20').value);
            
            if (!total || total < 4 || total > 80) {
                alert('Please enter a number between 4 and 80');
                return;
            }
            
            const output = document.getElementById('generator-output');
            output.innerHTML = '<p class="text-center">Generating encounter...</p>';
            output.classList.remove('hidden');
            
            const response = await fetch('/api/generate-4d20', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ total })
            });
            const data = await response.json();
            
            output.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">üé≤ 4d20 Encounter (${total})</h3>
                <div class="prose prose-invert max-w-none">
                    <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded">${data.content}</pre>
                </div>
            `;
            output.scrollIntoView({ behavior: 'smooth' });
        }

        async function generateV1Encounter() {
            const floor = parseInt(document.getElementById('v1-floor').value);
            
            const output = document.getElementById('generator-output');
            output.innerHTML = '<p class="text-center">Generating V1 encounter...</p>';
            output.classList.remove('hidden');
            
            const response = await fetch('/api/generate-v1', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ floor })
            });
            const data = await response.json();
            
            output.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">üé≤ Dungeon Turn V1 - Floor ${floor}</h3>
                <div class="prose prose-invert max-w-none">
                    <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded">${data.content}</pre>
                </div>
            `;
            output.scrollIntoView({ behavior: 'smooth' });
        }

        async function viewDoc() {
            const docPath = document.getElementById('doc-select').value;
            
            if (!docPath) {
                alert('Please select a document');
                return;
            }
            
            const output = document.getElementById('generator-output');
            output.innerHTML = '<p class="text-center">Loading document...</p>';
            output.classList.remove('hidden');
            
            const response = await fetch('/api/view-doc', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: docPath })
            });
            const data = await response.json();
            
            output.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">üìö ${data.title}</h3>
                    <a href="/api/download-doc?path=${encodeURIComponent(docPath)}" 
                       class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm">
                        Download
                    </a>
                </div>
                <div class="prose prose-invert max-w-none bg-gray-900 p-6 rounded">
                    ${data.html}
                </div>
            `;
            output.scrollIntoView({ behavior: 'smooth' });
        }

        async function generateHazard() {
            const level = parseInt(document.getElementById('hazard-level').value);
            
            if (isNaN(level) || level < -1 || level > 10) {
                alert('Please enter a level between -1 and 10');
                return;
            }
            
            const output = document.getElementById('generator-output');
            output.innerHTML = '<p class="text-center">Generating hazard...</p>';
            output.classList.remove('hidden');
            
            const response = await fetch('/api/generate-hazard', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ level })
            });
            const data = await response.json();
            
            output.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">‚ö†Ô∏è ${data.name} (Level ${data.level})</h3>
                <div class="prose prose-invert max-w-none">
                    <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded">${data.content}</pre>
                </div>
            `;
            output.scrollIntoView({ behavior: 'smooth' });
        }

        async function generateAllMerchants() {
            const level = parseInt(document.getElementById('all-merchants-level').value);
            
            if (isNaN(level) || level < 1 || level > 20) {
                alert('Please enter a party level between 1 and 20');
                return;
            }
            
            const btn = document.getElementById('generate-all-merchants-btn');
            const progressDiv = document.getElementById('merchant-progress');
            const progressBar = document.getElementById('merchant-progress-bar');
            const statusText = document.getElementById('merchant-status');
            
            // Disable button and show progress
            btn.disabled = true;
            btn.textContent = 'Generating...';
            progressDiv.classList.remove('hidden');
            progressBar.style.width = '0%';
            statusText.textContent = 'Starting merchant generation...';
            
            try {
                // Use EventSource for streaming progress
                const eventSource = new EventSource(`/api/generate-merchants-stream?player_level=${level}`);
                
                let totalLines = 0;
                let merchantCount = 0;
                const expectedMerchants = 12; // 10 Otari merchants + 2 random
                
                eventSource.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    
                    if (data.done) {
                        eventSource.close();
                        
                        if (data.success) {
                            progressBar.style.width = '100%';
                            statusText.textContent = 'All merchants generated successfully!';
                            statusText.classList.add('text-green-400');
                            
                            setTimeout(() => {
                                btn.disabled = false;
                                btn.textContent = 'Generate All Merchants';
                                progressDiv.classList.add('hidden');
                                statusText.classList.remove('text-green-400');
                                alert('Merchants generated successfully! Check the players/ and gm/ directories.');
                            }, 2000);
                        } else {
                            progressBar.style.width = '100%';
                            progressBar.classList.add('bg-red-600');
                            statusText.textContent = `Error: ${data.error}`;
                            statusText.classList.add('text-red-400');
                            
                            btn.disabled = false;
                            btn.textContent = 'Generate All Merchants';
                        }
                    } else if (data.line) {
                        totalLines++;
                        
                        // Count merchants being generated
                        if (data.line.includes('[MERCHANT') || data.line.includes('[RANDOM MERCHANT')) {
                            merchantCount++;
                            const progress = (merchantCount / expectedMerchants) * 100;
                            progressBar.style.width = `${progress}%`;
                        }
                        
                        // Update status with current line
                        statusText.textContent = data.line;
                        
                        // Log to console for debugging
                        console.log(data.line);
                    }
                };
                
                eventSource.onerror = function(error) {
                    eventSource.close();
                    progressBar.classList.add('bg-red-600');
                    statusText.textContent = 'Connection error. Check console for details.';
                    statusText.classList.add('text-red-400');
                    btn.disabled = false;
                    btn.textContent = 'Generate All Merchants';
                    console.error('EventSource error:', error);
                };
                
            } catch (error) {
                progressBar.classList.add('bg-red-600');
                statusText.textContent = `Error: ${error.message}`;
                statusText.classList.add('text-red-400');
                btn.disabled = false;
                btn.textContent = 'Generate All Merchants';
            }
        }

        function displayEncounter(event, diceTotal) {
            const display = document.getElementById('encounter-display');
            const categoryColors = {
                'OPPORTUNITY': 'from-green-600 to-emerald-600',
                'COMPLICATION': 'from-yellow-600 to-orange-600',
                'DILEMMA': 'from-blue-600 to-cyan-600',
                'ACTIVE_THREAT': 'from-red-600 to-pink-600',
                'COMBAT': 'from-purple-600 to-fuchsia-600'
            };

            // Check if extreme roll
            const isExtreme = diceTotal <= 8 || diceTotal >= 97;
            const extremeLabel = isExtreme ? '<div class="bg-red-900 border-2 border-red-500 p-2 rounded-lg mb-2 text-center"><span class="text-red-300 font-bold text-lg">‚ö° EXTREME ROLL! ‚ö°</span></div>' : '';

            let html = `
                ${extremeLabel}
                <div class="bg-gradient-to-r ${categoryColors[event.category]} p-1 rounded-lg mb-4">
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-bold text-gray-400">Dice Total: ${diceTotal}</span>
                            <span class="px-3 py-1 rounded-full text-sm font-bold bg-gradient-to-r ${categoryColors[event.category]}">${event.category}</span>
                        </div>
                        <h3 class="text-3xl font-bold mb-4">${event.title}</h3>
                        <p class="text-lg mb-4 text-gray-300">${event.description}</p>
            `;

            // Category-specific content
            if (event.category === 'OPPORTUNITY' || event.category === 'COMPLICATION') {
                // Parse success field for multiple options (separated by OR)
                let successHtml = '';
                if (event.success && event.success.includes(' OR ')) {
                    const options = event.success.split(' OR ');
                    successHtml = '<div class="space-y-2">';
                    options.forEach((option, index) => {
                        const optionLabel = option.match(/^([A-Z\s]+):/);
                        if (optionLabel) {
                            // Has a label like "COMBAT PREP:" or "FALLBACK PREP:"
                            const label = optionLabel[1];
                            const content = option.substring(optionLabel[0].length).trim();
                            successHtml += `<div class="bg-gray-700 p-3 rounded border-l-4 border-green-500">
                                <p class="font-bold text-green-300">Option ${index + 1}: ${label}</p>
                                <p class="text-gray-300 mt-1">${content}</p>
                            </div>`;
                        } else {
                            // No label, just show as option
                            successHtml += `<div class="bg-gray-700 p-3 rounded border-l-4 border-green-500">
                                <p class="font-bold text-green-300">Option ${index + 1}:</p>
                                <p class="text-gray-300 mt-1">${option.trim()}</p>
                            </div>`;
                        }
                    });
                    successHtml += '</div>';
                } else {
                    successHtml = `<p><strong class="text-green-400">Success:</strong> ${event.success}</p>`;
                }
                
                html += `
                    <div class="space-y-2 bg-gray-800 p-4 rounded-lg">
                        <p><strong class="text-purple-400">Challenge:</strong> ${event.challenge}</p>
                        ${successHtml}
                        <p><strong class="text-red-400">Failure:</strong> ${event.failure}</p>
                        <p><strong class="text-blue-400">Skills:</strong> ${event.skills.join(', ')}</p>
                        <p><strong class="text-yellow-400">Time Cost:</strong> ${event.time_cost}</p>
                        ${event.reward ? `<p><strong class="text-cyan-400">Reward:</strong> ${event.reward}</p>` : ''}
                        ${event.spotlight ? `<p><strong class="text-pink-400">Spotlight:</strong> ${event.spotlight.join(', ')}</p>` : ''}
                        ${event.consequence ? `<p><strong class="text-orange-400">Consequence:</strong> ${event.consequence}</p>` : ''}
                    </div>
                `;
            } else if (event.category === 'DILEMMA') {
                html += `
                    <div class="space-y-2 bg-gray-800 p-4 rounded-lg">
                        <p><strong class="text-purple-400">Choice A:</strong> ${event.choice_a}</p>
                        ${event.choice_b ? `<p><strong class="text-purple-400">Choice B:</strong> ${event.choice_b}</p>` : ''}
                        ${event.choice_c ? `<p><strong class="text-purple-400">Choice C:</strong> ${event.choice_c}</p>` : ''}
                        ${event.skills ? `<p><strong class="text-blue-400">Skills:</strong> ${event.skills.join(', ')}</p>` : ''}
                        ${event.time_cost ? `<p><strong class="text-yellow-400">Time Cost:</strong> ${event.time_cost}</p>` : ''}
                        ${event.consequence ? `<p><strong class="text-orange-400">Consequence:</strong> ${event.consequence}</p>` : ''}
                        ${event.spotlight ? `<p><strong class="text-pink-400">Spotlight:</strong> ${event.spotlight.join(', ')}</p>` : ''}
                        ${event.context ? `<p><strong class="text-cyan-400">Context:</strong> ${event.context}</p>` : ''}
                    </div>
                `;
            } else if (event.category === 'ACTIVE_THREAT') {
                html += `
                    <div class="bg-red-900 border-2 border-red-500 p-4 rounded-lg mb-4">
                        <p class="text-xl font-bold text-red-300">‚ö†Ô∏è ${event.urgency}</p>
                    </div>
                    <div class="space-y-2 bg-gray-800 p-4 rounded-lg">
                        <p><strong class="text-purple-400">Immediate Action:</strong> ${event.immediate_action}</p>
                        <p><strong class="text-green-400">Success:</strong> ${event.success}</p>
                        <p><strong class="text-red-400">Failure:</strong> ${event.failure}</p>
                        ${event.skills ? `<p><strong class="text-blue-400">Skills:</strong> ${event.skills.join(', ')}</p>` : ''}
                        ${event.threat_level ? `<p><strong class="text-orange-400">Threat Level:</strong> ${event.threat_level}</p>` : ''}
                        ${event.spotlight ? `<p><strong class="text-pink-400">Spotlight:</strong> ${event.spotlight.join(', ')}</p>` : ''}
                        ${event.creatures ? `<p><strong class="text-red-400">Creatures:</strong> ${event.creatures}</p>` : ''}
                    </div>
                `;
            } else if (event.category === 'COMBAT') {
                // Show difficulty warning for extreme encounters
                const difficultyClass = event.dice_sum === 100 ? 'bg-red-900 border-red-500' : 
                                       event.dice_sum >= 95 ? 'bg-orange-900 border-orange-500' : 
                                       'bg-gray-700 border-gray-600';
                const difficultyIcon = event.dice_sum === 100 ? 'üíÄ' : 
                                      event.dice_sum >= 95 ? '‚ö†Ô∏è' : 
                                      '‚öîÔ∏è';
                
                html += `
                    ${event.difficulty_note ? `
                        <div class="${difficultyClass} border-2 p-3 rounded-lg mb-3">
                            <p class="text-lg font-bold text-center">${difficultyIcon} ${event.difficulty_note}</p>
                        </div>
                    ` : ''}
                    <div class="space-y-2 bg-gray-800 p-4 rounded-lg">
                        <p><strong class="text-purple-400">Difficulty:</strong> ${event.difficulty}</p>
                        <p><strong class="text-purple-400">Ecology:</strong> ${event.ecology}</p>
                        <p><strong class="text-red-400">Creatures:</strong> ${event.num_creatures}x ${event.creatures.join(', ')} (Level ${event.creature_level})</p>
                        <p><strong class="text-yellow-400">Tactical Option:</strong> ${event.tactical_option}</p>
                        <p><strong class="text-green-400">Avoidable:</strong> ${event.avoidable ? 'Yes' : 'No'}</p>
                        <p><strong class="text-blue-400">Surprise Available:</strong> ${event.surprise_available ? 'Yes' : 'No'}</p>
                    </div>
                `;
                
                // Add creature stats if available
                if (event.creature_stats && event.creature_stats.length > 0) {
                    html += `
                        <div class="mt-4 bg-red-900 border-2 border-red-500 p-4 rounded-lg">
                            <h4 class="text-xl font-bold mb-3 text-red-300">‚öîÔ∏è Creature Stats</h4>
                            <div class="space-y-4">
                    `;
                    event.creature_stats.forEach(creature => {
                        html += `
                            <div class="bg-gray-900 p-4 rounded-lg border border-red-700">
                                <div class="flex gap-4 mb-3">
                                    <!-- Creature Image -->
                                    ${creature.image ? `
                                        <div class="flex-shrink-0">
                                            <img src="https://2e.aonprd.com${creature.image}" 
                                                 alt="${creature.name}" 
                                                 class="w-32 h-32 object-cover rounded-lg border-2 border-red-500"
                                                 onerror="this.style.display='none'">
                                        </div>
                                    ` : ''}
                                    
                                    <!-- Creature Info -->
                                    <div class="flex-grow">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <p class="font-bold text-xl text-red-300">${creature.name} (Level ${creature.level})</p>
                                                <p class="text-sm text-gray-400">${creature.size} ${creature.creature_type || ''} ${creature.alignment || ''}</p>
                                                <p class="text-xs text-gray-500">Rarity: ${creature.rarity} | Traits: ${(creature.traits || []).join(', ')}</p>
                                            </div>
                                            ${creature.url ? `<a href="https://2e.aonprd.com${creature.url}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">View on AoN ‚Üí</a>` : ''}
                                        </div>
                                        
                                        <!-- Basic Stats -->
                                        <div class="grid grid-cols-3 gap-2 text-sm">
                                            <p><strong>HP:</strong> ${creature.hp || 'Unknown'}</p>
                                            <p><strong>AC:</strong> ${creature.ac || 'Unknown'}</p>
                                            <p><strong>Perception:</strong> ${creature.perception || 'Unknown'}</p>
                                            ${creature.fort ? `<p><strong>Fort:</strong> ${creature.fort}</p>` : ''}
                                            ${creature.reflex ? `<p><strong>Reflex:</strong> ${creature.reflex}</p>` : ''}
                                            ${creature.will ? `<p><strong>Will:</strong> ${creature.will}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Skills -->
                                ${creature.skills && Object.keys(creature.skills).length > 0 ? `
                                    <div class="mt-3 p-3 bg-gray-800 rounded text-sm">
                                        <p class="font-bold text-cyan-300 mb-1">Skills:</p>
                                        <p class="text-gray-300">${Object.entries(creature.skills).map(([skill, bonus]) => `${skill} ${bonus}`).join(', ')}</p>
                                    </div>
                                ` : ''}
                                
                                <!-- Languages -->
                                ${creature.languages && creature.languages.length > 0 ? `
                                    <div class="mt-2 text-sm">
                                        <strong class="text-purple-300">Languages:</strong> ${creature.languages.join(', ')}
                                    </div>
                                ` : ''}
                                
                                <!-- Attacks -->
                                ${creature.attacks && creature.attacks.length > 0 ? `
                                    <div class="mt-3 p-3 bg-red-800 rounded">
                                        <p class="font-bold text-yellow-300 mb-2">‚öîÔ∏è Attacks:</p>
                                        <ul class="text-sm space-y-1">
                                            ${creature.attacks.map(atk => `<li>‚Ä¢ ${atk}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                <!-- Abilities -->
                                ${creature.abilities && creature.abilities.length > 0 ? `
                                    <div class="mt-3 p-3 bg-purple-900 rounded">
                                        <p class="font-bold text-purple-300 mb-2">‚ú® Special Abilities:</p>
                                        <ul class="text-sm space-y-1">
                                            ${creature.abilities.map(ab => `<li>‚Ä¢ ${ab}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                <!-- Defenses -->
                                ${(creature.immunities && creature.immunities.length > 0) || 
                                  (creature.resistances && creature.resistances.length > 0) || 
                                  (creature.weaknesses && creature.weaknesses.length > 0) ? `
                                    <div class="mt-3 p-3 bg-blue-900 rounded text-sm">
                                        <p class="font-bold text-blue-300 mb-1">üõ°Ô∏è Defenses:</p>
                                        ${creature.immunities && creature.immunities.length > 0 ? 
                                            `<p><strong>Immunities:</strong> ${creature.immunities.join(', ')}</p>` : ''}
                                        ${creature.resistances && creature.resistances.length > 0 ? 
                                            `<p><strong>Resistances:</strong> ${creature.resistances.join(', ')}</p>` : ''}
                                        ${creature.weaknesses && creature.weaknesses.length > 0 ? 
                                            `<p><strong>Weaknesses:</strong> ${creature.weaknesses.join(', ')}</p>` : ''}
                                    </div>
                                ` : ''}
                                
                                <!-- Warning if incomplete -->
                                ${!creature.attacks || creature.attacks.length === 0 ? `
                                    <div class="mt-3 p-2 bg-yellow-900 border border-yellow-600 rounded text-xs">
                                        <p class="text-yellow-300">‚ö†Ô∏è <strong>Note:</strong> Full stats not available. Check <a href="https://2e.aonprd.com" target="_blank" class="underline">Archives of Nethys</a>.</p>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    html += `
                            </div>
                        </div>
                    `;
                }
            }

            if (event.gm_notes) {
                html += `
                    <div class="mt-4 bg-yellow-900 border-l-4 border-yellow-500 p-4 rounded">
                        <p class="text-sm"><strong>GM Notes:</strong> ${event.gm_notes}</p>
                    </div>
                `;
            }



            html += `</div></div>`;
            display.innerHTML = html;
            display.classList.remove('hidden');
            display.scrollIntoView({ behavior: 'smooth' });
            
            // Store current event for tweaking
            window.currentEvent = event;
        }

        async function addDie() {
            const response = await fetch('/api/dice-jar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'add' })
            });
            const data = await response.json();
            updateDiceJar(data.dice_jar);
        }

        async function resetJar() {
            const response = await fetch('/api/dice-jar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'reset' })
            });
            const data = await response.json();
            updateDiceJar(data.dice_jar);
        }

        function updateDiceJar(count) {
            currentDiceJar = count;
            const display = document.getElementById('dice-jar-display');
            display.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const die = document.createElement('div');
                die.className = `w-16 h-16 rounded-lg flex items-center justify-center text-2xl font-bold transition ${
                    i < count ? 'bg-purple-600 shadow-lg' : 'bg-gray-700'
                }`;
                die.textContent = 'üé≤';
                display.appendChild(die);
            }

            const status = document.getElementById('jar-status');
            if (count >= 5) {
                status.textContent = 'üî• JAR IS FULL! Time to roll!';
                status.classList.add('text-red-400', 'font-bold');
            } else {
                status.textContent = `${count}/5 dice in jar. ${5 - count} more until roll.`;
                status.classList.remove('text-red-400', 'font-bold');
            }
        }

        async function updateHistory() {
            const response = await fetch('/api/history');
            const data = await response.json();
            const display = document.getElementById('history-display');
            
            if (data.history.length === 0) {
                display.innerHTML = '<p class="text-gray-400 text-center">No rolls yet</p>';
                return;
            }

            display.innerHTML = data.history.reverse().map(h => `
                <div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                    <span>Floor ${h.floor}: ${h.title}</span>
                    <span class="text-sm text-gray-400">${h.category} (${h.sum})</span>
                </div>
            `).join('');
        }

        async function clearHistory() {
            await fetch('/api/clear-history', { method: 'POST' });
            updateHistory();
        }

        // Wayne Reynolds art rotation
        const wrArt = [
            '/static/art/wr_goblin.jpg',
            '/static/art/wr_dragon.jpg',
            '/static/art/wr_dungeon.jpg',
            '/static/art/wr_combat.jpg',
            '/static/art/wr_monster.jpg'
        ];
        
        function rotateArt() {
            const randomArt = wrArt[Math.floor(Math.random() * wrArt.length)];
            const bgArt = document.getElementById('bg-art');
            bgArt.style.backgroundImage = `url('${randomArt}')`;
        }
        
        // Rotate art every 30 seconds
        rotateArt();
        setInterval(rotateArt, 30000);

        // Initialize
        updateDiceJar(0);
        updateHistory();

        // Toggle generators dropdown
        function toggleGenerators() {
            const content = document.getElementById('generators-content');
            const arrow = document.getElementById('generators-arrow');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }

        // Toggle filters dropdown
        function toggleFilters() {
            const content = document.getElementById('filters-content');
            const arrow = document.getElementById('filters-arrow');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }

        // Data Integrity Checker
        async function runDataIntegrity() {
            const type = document.getElementById('integrity-type').value;
            const count = document.getElementById('integrity-count').value;
            const fix = document.getElementById('integrity-fix').checked;
            const btn = document.getElementById('integrity-btn');
            const status = document.getElementById('integrity-status');
            
            btn.disabled = true;
            btn.textContent = 'Checking...';
            status.classList.remove('hidden');
            status.textContent = 'Running data integrity check...';
            
            try {
                const response = await fetch('/api/run-data-integrity', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, count, fix })
                });
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Check complete! See output below.';
                    status.classList.add('text-green-400');
                    
                    const output = document.getElementById('generator-output');
                    output.innerHTML = `
                        <h3 class="text-2xl font-bold mb-4">üîç Data Integrity Check - ${type}</h3>
                        <div class="prose prose-invert max-w-none">
                            <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded text-sm">${data.output}</pre>
                        </div>
                    `;
                    output.classList.remove('hidden');
                    output.scrollIntoView({ behavior: 'smooth' });
                } else {
                    status.textContent = `Error: ${data.error || 'Check failed'}`;
                    status.classList.add('text-red-400');
                }
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.classList.add('text-red-400');
            }
            
            btn.disabled = false;
            btn.textContent = 'Check Data';
        }

        // Scrape Creatures
        async function scrapeCreatures() {
            const btn = document.getElementById('scrape-creatures-btn');
            const status = document.getElementById('scrape-creatures-status');
            
            if (!confirm('This will scrape ALL creatures from Archives of Nethys. This may take several minutes. Continue?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Scraping...';
            status.classList.remove('hidden');
            status.textContent = 'Scraping creatures from AoN...';
            
            try {
                const response = await fetch('/api/scrape-creatures', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Scraping complete!';
                    status.classList.add('text-green-400');
                    
                    const output = document.getElementById('generator-output');
                    output.innerHTML = `
                        <h3 class="text-2xl font-bold mb-4">üï∑Ô∏è Creature Scraping Complete</h3>
                        <div class="prose prose-invert max-w-none">
                            <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded text-sm">${data.output}</pre>
                        </div>
                    `;
                    output.classList.remove('hidden');
                    output.scrollIntoView({ behavior: 'smooth' });
                } else {
                    status.textContent = `Error: ${data.error || 'Scraping failed'}`;
                    status.classList.add('text-red-400');
                }
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.classList.add('text-red-400');
            }
            
            btn.disabled = false;
            btn.textContent = 'Scrape All Creatures';
        }

        // Scrape Creature Lore
        async function scrapeCreatureLore() {
            const btn = document.getElementById('scrape-lore-btn');
            const status = document.getElementById('scrape-lore-status');
            
            if (!confirm('This will scrape creature lore from Archives of Nethys. This may take several minutes. Continue?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Scraping...';
            status.classList.remove('hidden');
            status.textContent = 'Scraping creature lore...';
            
            try {
                const response = await fetch('/api/scrape-creature-lore', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Lore scraping complete!';
                    status.classList.add('text-green-400');
                    
                    const output = document.getElementById('generator-output');
                    output.innerHTML = `
                        <h3 class="text-2xl font-bold mb-4">üìñ Creature Lore Scraping Complete</h3>
                        <div class="prose prose-invert max-w-none">
                            <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded text-sm">${data.output}</pre>
                        </div>
                    `;
                    output.classList.remove('hidden');
                    output.scrollIntoView({ behavior: 'smooth' });
                } else {
                    status.textContent = `Error: ${data.error || 'Scraping failed'}`;
                    status.classList.add('text-red-400');
                }
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.classList.add('text-red-400');
            }
            
            btn.disabled = false;
            btn.textContent = 'Scrape Lore';
        }

        // Scrape Spells
        async function scrapeSpells() {
            const btn = document.getElementById('scrape-spells-btn');
            const status = document.getElementById('scrape-spells-status');
            
            if (!confirm('This will scrape ALL spells from Archives of Nethys. This may take several minutes. Continue?')) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Scraping...';
            status.classList.remove('hidden');
            status.textContent = 'Scraping spells from AoN...';
            
            try {
                const response = await fetch('/api/scrape-spells', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Spell scraping complete!';
                    status.classList.add('text-green-400');
                    
                    const output = document.getElementById('generator-output');
                    output.innerHTML = `
                        <h3 class="text-2xl font-bold mb-4">‚ú® Spell Scraping Complete</h3>
                        <div class="prose prose-invert max-w-none">
                            <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded text-sm">${data.output}</pre>
                        </div>
                    `;
                    output.classList.remove('hidden');
                    output.scrollIntoView({ behavior: 'smooth' });
                } else {
                    status.textContent = `Error: ${data.error || 'Scraping failed'}`;
                    status.classList.add('text-red-400');
                }
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.classList.add('text-red-400');
            }
            
            btn.disabled = false;
            btn.textContent = 'Scrape Spells';
        }

        // Expand Encounter Pools
        async function expandEncounterPools() {
            const btn = document.getElementById('expand-pools-btn');
            const status = document.getElementById('expand-pools-status');
            
            btn.disabled = true;
            btn.textContent = 'Expanding...';
            status.classList.remove('hidden');
            status.textContent = 'Expanding encounter pools...';
            
            try {
                const response = await fetch('/api/expand-encounter-pools', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Pools expanded!';
                    status.classList.add('text-green-400');
                    
                    const output = document.getElementById('generator-output');
                    output.innerHTML = `
                        <h3 class="text-2xl font-bold mb-4">üé≤ Encounter Pools Expanded</h3>
                        <div class="prose prose-invert max-w-none">
                            <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded text-sm">${data.output}</pre>
                        </div>
                    `;
                    output.classList.remove('hidden');
                    output.scrollIntoView({ behavior: 'smooth' });
                } else {
                    status.textContent = `Error: ${data.error || 'Expansion failed'}`;
                    status.classList.add('text-red-400');
                }
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.classList.add('text-red-400');
            }
            
            btn.disabled = false;
            btn.textContent = 'Expand Pools';
        }

        // Reset Verification Dates
        async function resetVerification() {
            const type = document.getElementById('reset-type').value;
            const btn = document.getElementById('reset-verify-btn');
            const status = document.getElementById('reset-verify-status');
            
            if (!confirm(`Reset verification dates for ${type}? This will force re-checking all items.`)) {
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Resetting...';
            status.classList.remove('hidden');
            status.textContent = 'Resetting verification dates...';
            
            try {
                const response = await fetch('/api/reset-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type })
                });
                const data = await response.json();
                
                if (data.success) {
                    status.textContent = 'Verification dates reset!';
                    status.classList.add('text-green-400');
                    
                    const output = document.getElementById('generator-output');
                    output.innerHTML = `
                        <h3 class="text-2xl font-bold mb-4">üîÑ Verification Dates Reset - ${type}</h3>
                        <div class="prose prose-invert max-w-none">
                            <pre class="whitespace-pre-wrap bg-gray-900 p-4 rounded text-sm">${data.output}</pre>
                        </div>
                    `;
                    output.classList.remove('hidden');
                    output.scrollIntoView({ behavior: 'smooth' });
                } else {
                    status.textContent = `Error: ${data.error || 'Reset failed'}`;
                    status.classList.add('text-red-400');
                }
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.classList.add('text-red-400');
            }
            
            btn.disabled = false;
            btn.textContent = 'Reset Dates';
        }

        // ============================================
        // Event Filter Manager
        // ============================================
        
        const EventFilterManager = {
            // State
            allEvents: [],
            filteredEvents: [],
            
            // Initialize with event data
            init: function(events) {
                this.allEvents = events;
                this.attachEventListeners();
                this.updateFilters();
            },
            
            // Attach change listeners to all filter controls
            attachEventListeners: function() {
                document.getElementById('filter-categories').addEventListener('change', () => this.updateFilters());
                document.getElementById('filter-skills').addEventListener('change', () => this.updateFilters());
                document.getElementById('filter-time-cost').addEventListener('change', () => this.updateFilters());
                document.getElementById('filter-new-area').addEventListener('change', () => this.updateFilters());
                document.getElementById('filter-reward').addEventListener('input', () => this.updateFilters());
                document.getElementById('filter-threat-level').addEventListener('change', () => this.updateFilters());
            },
            
            // Get current filter values
            getFilterValues: function() {
                return {
                    categories: Array.from(document.getElementById('filter-categories').selectedOptions).map(o => o.value),
                    skills: Array.from(document.getElementById('filter-skills').selectedOptions).map(o => o.value),
                    timeCost: Array.from(document.getElementById('filter-time-cost').selectedOptions).map(o => o.value),
                    newArea: document.getElementById('filter-new-area').value,
                    reward: document.getElementById('filter-reward').value.toLowerCase(),
                    threatLevel: Array.from(document.getElementById('filter-threat-level').selectedOptions).map(o => o.value)
                };
            },
            
            // Apply filters to events
            filterEvents: function(events, filters) {
                return events.filter(event => {
                    // Category filter (OR logic within filter)
                    if (filters.categories.length > 0 && !filters.categories.includes(event.category)) {
                        return false;
                    }
                    
                    // Skills filter (OR logic within filter)
                    if (filters.skills.length > 0) {
                        const hasMatchingSkill = event.skills && event.skills.some(skill => filters.skills.includes(skill));
                        if (!hasMatchingSkill) return false;
                    }
                    
                    // Time cost filter (OR logic within filter)
                    if (filters.timeCost.length > 0) {
                        const timeCostStr = event.time_cost || '';
                        const matchesTimeCost = filters.timeCost.some(tc => {
                            if (tc === 'quick') return /\d+ action/i.test(timeCostStr);
                            if (tc === 'short') return /(5|10) min/i.test(timeCostStr);
                            if (tc === 'long') return /(20|30) min/i.test(timeCostStr);
                            return false;
                        });
                        if (!matchesTimeCost) return false;
                    }
                    
                    // New area filter
                    if (filters.newArea !== 'either') {
                        const requiresNewArea = event.requires_new_area === true;
                        if (filters.newArea === 'yes' && !requiresNewArea) return false;
                        if (filters.newArea === 'no' && requiresNewArea) return false;
                    }
                    
                    // Reward filter (text search, only for OPPORTUNITY events)
                    if (filters.reward && event.category === 'OPPORTUNITY') {
                        const reward = (event.reward || '').toLowerCase();
                        if (!reward.includes(filters.reward)) return false;
                    }
                    
                    // Threat level filter (OR logic within filter, only for ACTIVE_THREAT events)
                    if (filters.threatLevel.length > 0 && event.category === 'ACTIVE_THREAT') {
                        const threatLevel = event.threat_level || '';
                        const matchesThreatLevel = filters.threatLevel.some(tl => 
                            threatLevel.toLowerCase().includes(tl.toLowerCase())
                        );
                        if (!matchesThreatLevel) return false;
                    }
                    
                    return true;
                });
            },
            
            // Update filtered events and UI
            updateFilters: function() {
                const filters = this.getFilterValues();
                this.filteredEvents = this.filterEvents(this.allEvents, filters);
                this.updateMatchingCount();
                this.updatePreviewList();
            },
            
            // Update matching count display
            updateMatchingCount: function() {
                const countElement = document.getElementById('matching-count');
                countElement.textContent = this.filteredEvents.length;
                countElement.className = this.filteredEvents.length === 0 ? 'text-2xl text-red-400' : 'text-2xl text-green-400';
            },
            
            // Update preview list
            updatePreviewList: function() {
                const listElement = document.getElementById('event-preview-list');
                listElement.innerHTML = '';
                
                if (this.filteredEvents.length === 0) {
                    listElement.innerHTML = '<li class="text-red-400">No events match current filters</li>';
                    return;
                }
                
                const previewCount = Math.min(10, this.filteredEvents.length);
                for (let i = 0; i < previewCount; i++) {
                    const li = document.createElement('li');
                    li.textContent = `‚Ä¢ ${this.filteredEvents[i].title}`;
                    listElement.appendChild(li);
                }
                
                if (this.filteredEvents.length > 10) {
                    const li = document.createElement('li');
                    li.textContent = `... and ${this.filteredEvents.length - 10} more`;
                    li.className = 'text-gray-500 italic';
                    listElement.appendChild(li);
                }
            }
        };

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('filter-categories').selectedIndex = -1;
            document.getElementById('filter-skills').selectedIndex = -1;
            document.getElementById('filter-time-cost').selectedIndex = -1;
            document.getElementById('filter-new-area').value = 'either';
            document.getElementById('filter-reward').value = '';
            document.getElementById('filter-threat-level').selectedIndex = -1;
            EventFilterManager.updateFilters();
        }

        // Generate filtered event
        async function generateFilteredEvent() {
            const filters = EventFilterManager.getFilterValues();
            
            if (EventFilterManager.filteredEvents.length === 0) {
                alert('No events match your current filters. Please adjust your filters.');
                return;
            }
            
            const btn = document.getElementById('generate-filtered-event-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';
            
            try {
                const response = await fetch('/api/encounter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        floor: currentFloor,
                        sum: 50, // Dummy value since we're using filters
                        party_level: partyLevel,
                        filters: filters
                    })
                });
                
                const event = await response.json();
                displayEncounter(event, 50);
                updateHistory();
            } catch (error) {
                console.error('Error generating filtered event:', error);
                alert('Error generating event. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üé≤ GENERATE FILTERED EVENT';
            }
        }

        // Test floor filtering by generating 5 events rapidly
        async function testFloorFiltering() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'üß™ Testing...';
            
            const display = document.getElementById('encounter-display');
            display.innerHTML = '<p class="text-center text-gray-400">Generating 5 test events for Floor ' + currentFloor + '...</p>';
            display.classList.remove('hidden');
            
            try {
                let allEventsHtml = '<div class="space-y-6">';
                
                // Generate 5 events
                for (let i = 0; i < 5; i++) {
                    // Random dice total between 5 and 100
                    const randomSum = Math.floor(Math.random() * 96) + 5;
                    
                    const response = await fetch('/api/encounter', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            floor: currentFloor,
                            sum: randomSum,
                            party_level: partyLevel,
                            space_type: 'unknown',
                            party_status: 'healthy',
                            recent_combat: false,
                            new_area: true
                        })
                    });
                    
                    const event = await response.json();
                    
                    // Build HTML for this event using the same logic as displayEncounter
                    const categoryColors = {
                        'OPPORTUNITY': 'from-green-600 to-emerald-600',
                        'COMPLICATION': 'from-yellow-600 to-orange-600',
                        'DILEMMA': 'from-blue-600 to-cyan-600',
                        'ACTIVE_THREAT': 'from-red-600 to-pink-600',
                        'COMBAT': 'from-purple-600 to-fuchsia-600'
                    };

                    const isExtreme = randomSum <= 8 || randomSum >= 97;
                    const extremeLabel = isExtreme ? '<div class="bg-red-900 border-2 border-red-500 p-2 rounded-lg mb-2 text-center"><span class="text-red-300 font-bold text-lg">‚ö° EXTREME ROLL! ‚ö°</span></div>' : '';

                    let eventHtml = `
                        <div class="border-4 border-yellow-500 rounded-lg p-1">
                        ${extremeLabel}
                        <div class="bg-gradient-to-r ${categoryColors[event.category]} p-1 rounded-lg">
                            <div class="bg-gray-900 p-4 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-sm font-bold text-gray-400">Test Event ${i + 1} | Dice Total: ${randomSum} | Floor: ${event.floor}</span>
                                    <span class="px-3 py-1 rounded-full text-sm font-bold bg-gradient-to-r ${categoryColors[event.category]}">${event.category}</span>
                                </div>
                                <h3 class="text-3xl font-bold mb-4">${event.title}</h3>
                                <p class="text-lg mb-4 text-gray-300">${event.description}</p>
                    `;

                    // Category-specific content (same as displayEncounter)
                    if (event.category === 'OPPORTUNITY' || event.category === 'COMPLICATION') {
                        // Parse success field for multiple options (separated by OR)
                        let successHtml = '';
                        if (event.success && event.success.includes(' OR ')) {
                            const options = event.success.split(' OR ');
                            successHtml = '<div class="space-y-2">';
                            options.forEach((option, index) => {
                                const optionLabel = option.match(/^([A-Z\s]+):/);
                                if (optionLabel) {
                                    const label = optionLabel[1];
                                    const content = option.substring(optionLabel[0].length).trim();
                                    successHtml += `<div class="bg-gray-700 p-3 rounded border-l-4 border-green-500">
                                        <p class="font-bold text-green-300">Option ${index + 1}: ${label}</p>
                                        <p class="text-gray-300 mt-1">${content}</p>
                                    </div>`;
                                } else {
                                    successHtml += `<div class="bg-gray-700 p-3 rounded border-l-4 border-green-500">
                                        <p class="font-bold text-green-300">Option ${index + 1}:</p>
                                        <p class="text-gray-300 mt-1">${option.trim()}</p>
                                    </div>`;
                                }
                            });
                            successHtml += '</div>';
                        } else {
                            successHtml = `<p><strong class="text-green-400">Success:</strong> ${event.success}</p>`;
                        }
                        
                        eventHtml += `
                            <div class="space-y-2 bg-gray-800 p-4 rounded-lg">
                                <p><strong class="text-purple-400">Challenge:</strong> ${event.challenge}</p>
                                ${successHtml}
                                <p><strong class="text-red-400">Failure:</strong> ${event.failure}</p>
                                <p><strong class="text-blue-400">Skills:</strong> ${event.skills.join(', ')}</p>
                                <p><strong class="text-yellow-400">Time Cost:</strong> ${event.time_cost}</p>
                                ${event.reward ? `<p><strong class="text-cyan-400">Reward:</strong> ${event.reward}</p>` : ''}
                                ${event.spotlight ? `<p><strong class="text-pink-400">Spotlight:</strong> ${event.spotlight.join(', ')}</p>` : ''}
                                ${event.consequence ? `<p><strong class="text-orange-400">Consequence:</strong> ${event.consequence}</p>` : ''}
                            </div>
                        `;
                    } else if (event.category === 'DILEMMA') {
                        eventHtml += `
                            <div class="space-y-2 bg-gray-800 p-4 rounded-lg">
                                <p><strong class="text-purple-400">Choice A:</strong> ${event.choice_a}</p>
                                ${event.choice_b ? `<p><strong class="text-purple-400">Choice B:</strong> ${event.choice_b}</p>` : ''}
                                ${event.choice_c ? `<p><strong class="text-purple-400">Choice C:</strong> ${event.choice_c}</p>` : ''}
                                ${event.skills ? `<p><strong class="text-blue-400">Skills:</strong> ${event.skills.join(', ')}</p>` : ''}
                                ${event.time_cost ? `<p><strong class="text-yellow-400">Time Cost:</strong> ${event.time_cost}</p>` : ''}
                                ${event.consequence ? `<p><strong class="text-orange-400">Consequence:</strong> ${event.consequence}</p>` : ''}
                                ${event.spotlight ? `<p><strong class="text-pink-400">Spotlight:</strong> ${event.spotlight.join(', ')}</p>` : ''}
                                ${event.context ? `<p><strong class="text-cyan-400">Context:</strong> ${event.context}</p>` : ''}
                            </div>
                        `;
                    } else if (event.category === 'ACTIVE_THREAT') {
                        eventHtml += `
                            <div class="bg-red-900 border-2 border-red-500 p-4 rounded-lg mb-4">
                                <p class="text-xl font-bold text-red-300">‚ö†Ô∏è ${event.urgency}</p>
                            </div>
                            <div class="space-y-2 bg-gray-800 p-4 rounded-lg">
                                <p><strong class="text-purple-400">Immediate Action:</strong> ${event.immediate_action}</p>
                                <p><strong class="text-green-400">Success:</strong> ${event.success}</p>
                                <p><strong class="text-red-400">Failure:</strong> ${event.failure}</p>
                                ${event.skills ? `<p><strong class="text-blue-400">Skills:</strong> ${event.skills.join(', ')}</p>` : ''}
                                ${event.threat_level ? `<p><strong class="text-orange-400">Threat Level:</strong> ${event.threat_level}</p>` : ''}
                                ${event.spotlight ? `<p><strong class="text-pink-400">Spotlight:</strong> ${event.spotlight.join(', ')}</p>` : ''}
                                ${event.creatures ? `<p><strong class="text-red-400">Creatures:</strong> ${event.creatures}</p>` : ''}
                            </div>
                        `;
                    }

                    eventHtml += `
                                <div class="mt-4 text-sm text-gray-500">
                                    <strong>GM Notes:</strong> ${event.gm_notes || 'None'}
                                </div>
                            </div>
                        </div>
                        </div>
                    `;
                    
                    allEventsHtml += eventHtml;
                }
                
                allEventsHtml += '</div>';
                display.innerHTML = allEventsHtml;
                display.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error testing floor filtering:', error);
                display.innerHTML = `
                    <div class="text-center text-red-400">
                        <h3 class="text-2xl font-bold mb-4">üß™ Test Failed</h3>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üß™ Test Floor Filter (Generate 5 Events)';
            }
        }


    </script>
</body>
</html>
